#include <stdio.h>
#include <string>
#include <iostream>

using namespace std;

class awhalae {
public:
	double ynjvvpyr;
	awhalae();
	double qkzbtjdjoht(double dohadpueaqx, double gztohanvwnuuuzu, int nmgfuxsns, double iuvqliwlh, string noupjcckof, double ztzlmuxiunc);
	string ozmarkqauvlkwcd(string ggwkpnvjranb, double jttlwieqregvs, int herikyzbuejbiu, double yjmwabpyz, string poacybjqhe, string tetmy, bool bskzdqybrho, double vbwgafp, string wdhelkidvwq, int tujbgtwm);
	double blcmduoxhzsilncshqzpm(bool bnhyrqfcfzp, string rcnpfgoufwfvoru, bool bxnhnhpwog, bool kkomqorfk, string kovpdkzbfb, double cepmwiluqeyb, string bobwxv, string uopfhljff);
	void coqfmpxmgdgycnlqdbibui(string ysqfkex, double bdmjravqum, string wgaqcu);
	bool dqsmqphlgmpahv(double hucvjjtpybsonln, double etjpjxgvd, bool mkqxwhfvzqop);

protected:
	int adjhluqsts;
	double sdaxasbh;

	string igmayqhvjffkewzfkqxycwa(int mmkrjpk, double tgtdepfgb, int qwnijh, bool sttgucrqldmyeaf, int xqxlhbdjz);
	double ovhvxkejsrquoyadpcunqi(bool zebrlhi, int wfbtzlgritlirtu);

private:
	bool ytqzphvcwgvj;
	double gvoramaxvmdkn;

	bool oxrihpxfsrdvxv(string jxjem, double vandpnckhss, string qqkrmyp);
	int oqfqompakwv(double zooikftukimp, int gijrnoykf, bool yrjaczqvnjacmj, string syuxle, string aejxakrpepatkp, string mdopvtv, int iisjmolueoo, double zejznfkks, double pgwfyevvejbqmyc, string uzhurzhxawet);
	bool kbovsvikzqwtjwfnrecmlftrr(bool onvqygm, double ukjedktvp, bool fuqsgzkglmhd, int afcyzoge, bool xgmyrb, string dydrvvftr, bool yyehfvorukfnjo, bool vjeyvwyxnuavwbs);
	int tazcqjsklttlhws(string cvyyvvftqqgetc, string kleavq, string xtlhqkidhry, bool flzqnivovoo, bool kpcnxrgkuez, double vhoedxjzcjkrzn, int qchfptwzhpmvf);
	double xfidsaqehksvskixwknzrq(double btvly, double jtevzhyk, int irdrwvc, double rkqkdzy);
	bool ykbpvoedhjzcqjzgwoautrixd(int iotkdirpgphoquo, double paytyohwvb, int hmemerrr, double vgajynexrdz);
	int tpclkpzoiotybqizuhat(int mlgjsc, double dzllongr, double bsaixdz, bool aphhimnaeabw, int oxgkiowotyyxiq);
	bool yqbkuzesvdhcjxbvlbydvhd(bool peswbaacurnisa, bool vfhlqjwf, int nhzxuyp);

};


bool awhalae::oxrihpxfsrdvxv(string jxjem, double vandpnckhss, string qqkrmyp) {
	return false;
}

int awhalae::oqfqompakwv(double zooikftukimp, int gijrnoykf, bool yrjaczqvnjacmj, string syuxle, string aejxakrpepatkp, string mdopvtv, int iisjmolueoo, double zejznfkks, double pgwfyevvejbqmyc, string uzhurzhxawet) {
	double zdhfwnwfd = 1491;
	string sjnwytsnv = "bialqjvcn";
	int dhfxzfyqpjyvoeq = 4298;
	double dbznvmj = 21594;
	double zdeoijqnywrwjar = 33;
	double djgsrmdqk = 40682;
	string gyeudrs = "vandstnwcgybazkvvlcdetldazolkuqnysuifynqordimsvjtaihqfvjnwkkdebztyqurdusve";
	if (40682 == 40682) {
		int rk;
		for (rk = 85; rk > 0; rk--) {
			continue;
		}
	}
	if (33 != 33) {
		int jiyqlqwad;
		for (jiyqlqwad = 92; jiyqlqwad > 0; jiyqlqwad--) {
			continue;
		}
	}
	if (40682 != 40682) {
		int stn;
		for (stn = 82; stn > 0; stn--) {
			continue;
		}
	}
	if (21594 != 21594) {
		int krihqr;
		for (krihqr = 58; krihqr > 0; krihqr--) {
			continue;
		}
	}
	return 82275;
}

bool awhalae::kbovsvikzqwtjwfnrecmlftrr(bool onvqygm, double ukjedktvp, bool fuqsgzkglmhd, int afcyzoge, bool xgmyrb, string dydrvvftr, bool yyehfvorukfnjo, bool vjeyvwyxnuavwbs) {
	string oenhjfgsnshvzp = "juehhdsppusvkwgsxsiknwahcwugjumyyhrvrbkdtelgzihdpnviqcrsoefmtipqceudzxfjdrzuhdmupqvkmcwih";
	int fmdbyvddgdbzxpb = 1180;
	bool sfvap = false;
	int twjvgarjur = 881;
	if (false != false) {
		int bb;
		for (bb = 28; bb > 0; bb--) {
			continue;
		}
	}
	if (false != false) {
		int zqgzueetc;
		for (zqgzueetc = 39; zqgzueetc > 0; zqgzueetc--) {
			continue;
		}
	}
	if (string("juehhdsppusvkwgsxsiknwahcwugjumyyhrvrbkdtelgzihdpnviqcrsoefmtipqceudzxfjdrzuhdmupqvkmcwih") != string("juehhdsppusvkwgsxsiknwahcwugjumyyhrvrbkdtelgzihdpnviqcrsoefmtipqceudzxfjdrzuhdmupqvkmcwih")) {
		int uqwblbds;
		for (uqwblbds = 100; uqwblbds > 0; uqwblbds--) {
			continue;
		}
	}
	if (1180 != 1180) {
		int dngau;
		for (dngau = 54; dngau > 0; dngau--) {
			continue;
		}
	}
	return false;
}

int awhalae::tazcqjsklttlhws(string cvyyvvftqqgetc, string kleavq, string xtlhqkidhry, bool flzqnivovoo, bool kpcnxrgkuez, double vhoedxjzcjkrzn, int qchfptwzhpmvf) {
	bool hhrus = false;
	string qiqkyhjcx = "nhv";
	int vsxnzqxlvpzk = 716;
	int fpyxovlmescpyb = 6322;
	double jzoggnte = 27559;
	string kcoiixygu = "vggdwztvbnmb";
	double zmuvd = 48296;
	bool imdnzrzrzkivo = false;
	int okxhbf = 785;
	bool qmvtmmo = false;
	if (string("nhv") != string("nhv")) {
		int fmtaxsnfg;
		for (fmtaxsnfg = 74; fmtaxsnfg > 0; fmtaxsnfg--) {
			continue;
		}
	}
	if (48296 != 48296) {
		int kwlazxt;
		for (kwlazxt = 10; kwlazxt > 0; kwlazxt--) {
			continue;
		}
	}
	if (6322 != 6322) {
		int vwjkgsn;
		for (vwjkgsn = 67; vwjkgsn > 0; vwjkgsn--) {
			continue;
		}
	}
	if (false == false) {
		int xzo;
		for (xzo = 62; xzo > 0; xzo--) {
			continue;
		}
	}
	if (false == false) {
		int xzyu;
		for (xzyu = 85; xzyu > 0; xzyu--) {
			continue;
		}
	}
	return 47828;
}

double awhalae::xfidsaqehksvskixwknzrq(double btvly, double jtevzhyk, int irdrwvc, double rkqkdzy) {
	return 22462;
}

bool awhalae::ykbpvoedhjzcqjzgwoautrixd(int iotkdirpgphoquo, double paytyohwvb, int hmemerrr, double vgajynexrdz) {
	bool stxaiuxo = false;
	bool bwlcu = false;
	string aowpldgg = "tygsammkuoxycenhhaqdmekymgobvhfjnqunzpbgvofckwjgprejdncqjep";
	if (false != false) {
		int exooes;
		for (exooes = 86; exooes > 0; exooes--) {
			continue;
		}
	}
	return true;
}

int awhalae::tpclkpzoiotybqizuhat(int mlgjsc, double dzllongr, double bsaixdz, bool aphhimnaeabw, int oxgkiowotyyxiq) {
	string mwpzmhoncvmgymb = "aairbvvlnvpiefkdyxcexnfastpwgnbswtubizkbutvwbjneqnezyhyrarivobbtutvjsgfwchqgkmwpggfmw";
	int sawndliozpocez = 1650;
	double gdceek = 56458;
	if (56458 != 56458) {
		int xfbuhy;
		for (xfbuhy = 73; xfbuhy > 0; xfbuhy--) {
			continue;
		}
	}
	if (56458 == 56458) {
		int mivx;
		for (mivx = 26; mivx > 0; mivx--) {
			continue;
		}
	}
	if (1650 == 1650) {
		int fzaqbdgoz;
		for (fzaqbdgoz = 31; fzaqbdgoz > 0; fzaqbdgoz--) {
			continue;
		}
	}
	if (1650 != 1650) {
		int dxtiflgjg;
		for (dxtiflgjg = 25; dxtiflgjg > 0; dxtiflgjg--) {
			continue;
		}
	}
	return 66887;
}

bool awhalae::yqbkuzesvdhcjxbvlbydvhd(bool peswbaacurnisa, bool vfhlqjwf, int nhzxuyp) {
	bool agpvcq = false;
	int hhpdqehhbmd = 4966;
	int flwkrpuors = 7150;
	int fxslgoadkxpq = 613;
	bool ynmon = false;
	double sbpirim = 91750;
	double bqswemw = 26095;
	int daefsagpdm = 3352;
	int kfehqcycxhn = 2171;
	double mezaisgcgun = 19157;
	if (91750 != 91750) {
		int wpvdvnzdo;
		for (wpvdvnzdo = 24; wpvdvnzdo > 0; wpvdvnzdo--) {
			continue;
		}
	}
	return false;
}

string awhalae::igmayqhvjffkewzfkqxycwa(int mmkrjpk, double tgtdepfgb, int qwnijh, bool sttgucrqldmyeaf, int xqxlhbdjz) {
	string ofwurdhcvn = "iepneghfnadnxxjvrxxngpyhyqqbzxbilcabbpkwyxshoknytiltyraxxlkpavgyaggrkjclloowmkxu";
	bool phajxc = false;
	int kzhcjpen = 1665;
	if (false == false) {
		int tbsu;
		for (tbsu = 70; tbsu > 0; tbsu--) {
			continue;
		}
	}
	return string("zlwdxciutlckgmvifhwn");
}

double awhalae::ovhvxkejsrquoyadpcunqi(bool zebrlhi, int wfbtzlgritlirtu) {
	bool jmwjmeqmaqhq = true;
	int nivmagulpk = 668;
	bool cdhmo = false;
	int uymfussgxfja = 1153;
	double teryqbnfz = 4578;
	double uryuelxj = 15151;
	double dxeysxoagnpz = 36222;
	string fimfhqwoiik = "asmqnmepqlnafbxsrlngembedknizdolpjshyakdgkucqdxzbetxclxfvbduzumzsovdjxmvbk";
	bool vrqep = true;
	bool ltlqqdtb = true;
	if (4578 == 4578) {
		int omgr;
		for (omgr = 96; omgr > 0; omgr--) {
			continue;
		}
	}
	if (string("asmqnmepqlnafbxsrlngembedknizdolpjshyakdgkucqdxzbetxclxfvbduzumzsovdjxmvbk") != string("asmqnmepqlnafbxsrlngembedknizdolpjshyakdgkucqdxzbetxclxfvbduzumzsovdjxmvbk")) {
		int wtfaoatzoe;
		for (wtfaoatzoe = 93; wtfaoatzoe > 0; wtfaoatzoe--) {
			continue;
		}
	}
	return 22737;
}

double awhalae::qkzbtjdjoht(double dohadpueaqx, double gztohanvwnuuuzu, int nmgfuxsns, double iuvqliwlh, string noupjcckof, double ztzlmuxiunc) {
	int tjdbiunijiwm = 2177;
	bool riumjqmomabspmn = true;
	bool kxcealo = true;
	double xignshsmivo = 3003;
	bool xwsmixvky = true;
	if (true != true) {
		int tyxzwrys;
		for (tyxzwrys = 58; tyxzwrys > 0; tyxzwrys--) {
			continue;
		}
	}
	return 61819;
}

string awhalae::ozmarkqauvlkwcd(string ggwkpnvjranb, double jttlwieqregvs, int herikyzbuejbiu, double yjmwabpyz, string poacybjqhe, string tetmy, bool bskzdqybrho, double vbwgafp, string wdhelkidvwq, int tujbgtwm) {
	bool gkaylvmrvnkh = true;
	int fdxivqjquuy = 1725;
	int vuvofbwrugf = 6867;
	if (1725 != 1725) {
		int qv;
		for (qv = 58; qv > 0; qv--) {
			continue;
		}
	}
	return string("i");
}

double awhalae::blcmduoxhzsilncshqzpm(bool bnhyrqfcfzp, string rcnpfgoufwfvoru, bool bxnhnhpwog, bool kkomqorfk, string kovpdkzbfb, double cepmwiluqeyb, string bobwxv, string uopfhljff) {
	double ltqomqzuiqd = 11821;
	bool xtcpuaktz = false;
	double bxtyyfu = 8958;
	bool rlokabu = false;
	bool cfponcwxhqmkscs = true;
	if (11821 == 11821) {
		int isyybg;
		for (isyybg = 4; isyybg > 0; isyybg--) {
			continue;
		}
	}
	if (false != false) {
		int xuj;
		for (xuj = 37; xuj > 0; xuj--) {
			continue;
		}
	}
	if (8958 != 8958) {
		int afqnbgfu;
		for (afqnbgfu = 78; afqnbgfu > 0; afqnbgfu--) {
			continue;
		}
	}
	return 30828;
}

void awhalae::coqfmpxmgdgycnlqdbibui(string ysqfkex, double bdmjravqum, string wgaqcu) {

}

bool awhalae::dqsmqphlgmpahv(double hucvjjtpybsonln, double etjpjxgvd, bool mkqxwhfvzqop) {
	int zapzmpg = 1322;
	double ojqlmzkijienoez = 26203;
	bool jtcooo = false;
	int exocghjlsqlbtyp = 2686;
	int mdxkmoprfakkykq = 1632;
	if (false != false) {
		int pdn;
		for (pdn = 95; pdn > 0; pdn--) {
			continue;
		}
	}
	if (1322 == 1322) {
		int wajfbnhfiq;
		for (wajfbnhfiq = 69; wajfbnhfiq > 0; wajfbnhfiq--) {
			continue;
		}
	}
	return true;
}

awhalae::awhalae() {
	this->qkzbtjdjoht(6208, 4499, 987, 29705, string("gnx"), 84619);
	this->ozmarkqauvlkwcd(string("gvlpqsmlizxtgihmmjrygprppilcryxconzygrgrwnhbprsubhenhtukmpbazlhvumfjcbarvquhzaxiprltpwyxzidymb"), 40423, 3319, 35369, string("qpyrwxwlhumbnvalyqwucllknrbnsrhedihnafcweytdvzstkwdfdszesimssdzcohdfxvmt"), string("pjbiqhnsjkubnpfrdvtxmmbjqknaeweeedu"), true, 74500, string("jouctdvlnoxevnipfbdpvpgwpqzqwhtpfkpqkpxlfwqycnlsl"), 5735);
	this->blcmduoxhzsilncshqzpm(true, string("yhwrcxikxqvdzmqjpgwzqyipdrcwuzhpuoqmgxrsnvkwwhiwjoycoflxytaonxinqodhfzlowcsaolpzlaujuyrxsjx"), false, false, string("tsayivtwfsvobbmlldvljbzmhbgeythdhhhofkjwxcybjxxfxgzwoccnakdwlqvnnhmvtqrncd"), 19713, string("wwcgfusjdxaziitwekgpfctkygnrvjczwuzn"), string("qfqkudkljofexyffgkwlsxwgcvgnexeihztkgpitvpomd"));
	this->coqfmpxmgdgycnlqdbibui(string("cxpeivwutwkrtqghkxhxgxlmmuvctouwrunwtaxgovfenmyei"), 17910, string("abdhurxhtgreptrdwpgdvxndqpdyhakisgzxzvvfgsmteqqrqfoeoyroructcgsoszsgyxhztcwkdrd"));
	this->dqsmqphlgmpahv(17582, 15981, false);
	this->igmayqhvjffkewzfkqxycwa(653, 63923, 6129, false, 2188);
	this->ovhvxkejsrquoyadpcunqi(true, 235);
	this->oxrihpxfsrdvxv(string("eqxbhiexlzszimvifgzmxtqzqkftspjaifpfkdcrnijhuluuufgslsnjcjmfxrvzhrgolfmwngsavghjqhtcnfdhkinww"), 23876, string("vbdaleytcfwezuouekzumqgdnarflhemjoubovplmgjeuvfnnjrf"));
	this->oqfqompakwv(6015, 1270, true, string("vacbvkqmiildfszygpxetegznpegyvayfazwoqcqbpcoqehdbqhyxwjyxjvacumrxgvpyeubjxbcxy"), string("nocsvxfjftrjivonyfossftqtstuvrrxshhpoqqtmwnbbpsvuqhoktuhwgddfchpegrkbiikd"), string("etvetouifhhropirmrmeyulrsvieeglnwgyzunchhcnntmiaqttzwkgepswvqbhqnqlspdgnyjgtrocihlvuqnuqqlnvheedy"), 1124, 6335, 15402, string("ncvmndmgt"));
	this->kbovsvikzqwtjwfnrecmlftrr(true, 40666, true, 1428, true, string("fmxtexjaemphfvwivknwnxmrmuwyrrvovtl"), true, true);
	this->tazcqjsklttlhws(string("hqtywdvwmrnlzluaywzsmbhibeeieqcbswznijtcqgvnhrawvzj"), string("glmepqqbyzeaavttevz"), string("qpkjkwhaqyaprlqzacthyzuueajxnuyglkutuowukyprbimulhrwmzfpqotqirk"), false, false, 14533, 4377);
	this->xfidsaqehksvskixwknzrq(37765, 2565, 9, 53352);
	this->ykbpvoedhjzcqjzgwoautrixd(6656, 811, 8627, 25638);
	this->tpclkpzoiotybqizuhat(1417, 19956, 11995, true, 1715);
	this->yqbkuzesvdhcjxbvlbydvhd(false, false, 5067);
}


#include "AutoWall.h"
//#include "R.h"

#define    HITGROUP_GENERIC    0
#define    HITGROUP_HEAD        1
#define    HITGROUP_CHEST        2
#define    HITGROUP_STOMACH    3
#define HITGROUP_LEFTARM    4    
#define HITGROUP_RIGHTARM    5
#define HITGROUP_LEFTLEG    6
#define HITGROUP_RIGHTLEG    7
#define HITGROUP_GEAR        10

inline bool CGameTrace::DidHitWorld() const
{
	return m_pEnt->GetIndex() == 0;
}

inline bool CGameTrace::DidHitNonWorldEntity() const
{
	return m_pEnt != NULL && !DidHitWorld();
}

bool HandleBulletPenetration(CSWeaponInfo *wpn_data, FireBulletData &data);
float GetHitgroupDamageMult(int iHitGroup)
{
	switch (iHitGroup)
	{
	case HITGROUP_GENERIC:
		return 1.f;
	case HITGROUP_HEAD:
		return 4.f;
	case HITGROUP_CHEST:
		return 1.f;
	case HITGROUP_STOMACH:
		return 1.25f;
	case HITGROUP_LEFTARM:
		return 1.f;
	case HITGROUP_RIGHTARM:
		return 1.f;
	case HITGROUP_LEFTLEG:
		return 0.75f;
	case HITGROUP_RIGHTLEG:
		return 0.75f;
	case HITGROUP_GEAR:
		return 1.f;
	default:
		break;
	}

	return 1.f;
}
bool IsArmored(C_BaseEntity* Entity, int ArmorValue, int Hitgroup)
{
    bool result = false;

    if (ArmorValue > 0)
    {
        switch (Hitgroup)
        {
        case HITGROUP_GENERIC:
        case HITGROUP_CHEST:
        case HITGROUP_STOMACH:
        case HITGROUP_LEFTARM:
        case HITGROUP_RIGHTARM:
            result = true;
            break;
        case HITGROUP_HEAD:
            result = Entity->HasHelmet(); // DT_CSPlayer -> m_bHasHelmet
            break;
        }
    }

    return result;
}

void ScaleDamage(int Hitgroup,  C_BaseEntity* Entity, float WeaponArmorRatio, float &Damage)
{
    // NOTE: the Guardian/Coop Missions/Gamemode have bots with heavy armor which has a less damage modifier
    auto HeavyArmor = Entity->m_bHasHeavyArmor(); // DT_CSPlayer -> m_bHasHeavyArmor
    auto ArmorValue = Entity->ArmorValue(); // DT_CSPlayer -> m_ArmorValue

    switch (Hitgroup)
    {
    case HITGROUP_HEAD:
        if (HeavyArmor)
            Damage = (Damage * 4.f) * 0.5f;
        else
            Damage *= 4.f;
        break;
    case HITGROUP_STOMACH:
        Damage *= 1.25f;
        break;
    case HITGROUP_LEFTLEG:
    case HITGROUP_RIGHTLEG:
        Damage *= 0.75f;
        break;
    }

    if (IsArmored(Entity, ArmorValue, Hitgroup))
    {
        float v47 = 1.f, ArmorBonusRatio = 0.5f, ArmorRatio = WeaponArmorRatio * 0.5f;

        if (HeavyArmor)
        {
            ArmorBonusRatio = 0.33f;
            ArmorRatio = (WeaponArmorRatio * 0.5f) * 0.5f;
            v47 = 0.33f;
        }

        auto NewDamage = Damage * ArmorRatio;

        if (HeavyArmor)
            NewDamage *= 0.85f;

        if (((Damage - (Damage * ArmorRatio)) * (v47 * ArmorBonusRatio)) > ArmorValue)
            NewDamage = Damage - (ArmorValue / ArmorBonusRatio);

        Damage = NewDamage;
    }
}

/*void ScaleDamage(int hitgroup, C_BaseEntity *enemy, float weapon_armor_ratio, float &current_damage)
{
	current_damage *= GetHitgroupDamageMult(hitgroup);

	if (enemy->ArmorValue() > 0)
	{
		if (hitgroup == HITGROUP_HEAD)
		{
			if (enemy->HasHelmet())
			{
				current_damage *= (weapon_armor_ratio * 0.25f);
			}
		}
		else
		{
			current_damage *= (weapon_armor_ratio * 0.5f);
		}
	}

}*/

bool SimulateFireBullet(C_BaseEntity* entity, C_BaseEntity *local, CBaseCombatWeapon *weapon, FireBulletData &data)
{
	//Utils::ToLog("SimulateFireBullet");
	data.penetrate_count = 4;
	data.trace_length = 0.0f;
	auto *wpn_data = weapon->GetCSWpnData();

	data.current_damage = static_cast<float>(wpn_data->m_iDamage);

	while ((data.penetrate_count > 0) && (data.current_damage >= 1.0f))
	{
		data.trace_length_remaining = wpn_data->m_fRange - data.trace_length;

		Vector end = data.src + data.direction * data.trace_length_remaining;

		UTIL_TraceLine(data.src, end, 0x4600400B, local, 0, &data.enter_trace);
		UTIL_ClipTraceToPlayers(entity, data.src, end + data.direction * 40.f, 0x4600400B, &data.filter, &data.enter_trace);

		if (data.enter_trace.fraction == 1.0f)
			break;

		if ((data.enter_trace.hitgroup <= 7)
			&& (data.enter_trace.hitgroup > 0)
			&& (local->GetTeamNum() != data.enter_trace.m_pEnt->GetTeamNum()
				|| g_Options.Ragebot.FriendlyFire))
		{
			data.trace_length += (float)(data.enter_trace.fraction * data.trace_length_remaining);
			data.current_damage *= (float)(pow(wpn_data->m_fRangeModifier, data.trace_length * 0.002));
			ScaleDamage(data.enter_trace.hitgroup, data.enter_trace.m_pEnt, wpn_data->m_fArmorRatio, data.current_damage);

			return true;
		}

		if (!HandleBulletPenetration(wpn_data, data))
			break;
	}

	return false;
}

bool HandleBulletPenetration(CSWeaponInfo *wpn_data, FireBulletData &data)
{
	surfacedata_t *enter_surface_data = g_PhysProps->GetSurfaceData(data.enter_trace.surface.surfaceProps);
	int enter_material = enter_surface_data->game.material;
	float enter_surf_penetration_mod = enter_surface_data->game.flPenetrationModifier;


	data.trace_length += data.enter_trace.fraction * data.trace_length_remaining;
	data.current_damage *= (float)(pow(wpn_data->m_fRangeModifier, (data.trace_length * 0.002)));

	if ((data.trace_length > 3000.f) || (enter_surf_penetration_mod < 0.1f))
		data.penetrate_count = 0;

	if (data.penetrate_count <= 0)
		return false;

	Vector dummy;
	trace_t trace_exit;
	if (!TraceToExit(dummy, data.direction, data.enter_trace.endpos, data.enter_trace, trace_exit))
		return false;

	surfacedata_t *exit_surface_data = g_PhysProps->GetSurfaceData(trace_exit.surface.surfaceProps);
	int exit_material = exit_surface_data->game.material;

	float exit_surf_penetration_mod = exit_surface_data->game.flPenetrationModifier;
	float final_damage_modifier = 0.16f;
	float combined_penetration_modifier = 0.0f;

	if (((data.enter_trace.contents & CONTENTS_GRATE) != 0) || (enter_material == 89) || (enter_material == 71))
	{
		combined_penetration_modifier = 3.0f;
		final_damage_modifier = 0.05f;
	}
	else
	{
		combined_penetration_modifier = (enter_surf_penetration_mod + exit_surf_penetration_mod) * 0.5f;
	}

	if (enter_material == exit_material)
	{
		if (exit_material == 87 || exit_material == 85)
			combined_penetration_modifier = 3.0f;
		else if (exit_material == 76)
			combined_penetration_modifier = 2.0f;
	}

	float v34 = fmaxf(0.f, 1.0f / combined_penetration_modifier);
	float v35 = (data.current_damage * final_damage_modifier) + v34 * 3.0f * fmaxf(0.0f, (3.0f / wpn_data->m_fPenetration) * 1.25f);
	float thickness = VectorLength(trace_exit.endpos - data.enter_trace.endpos);

	thickness *= thickness;
	thickness *= v34;
	thickness /= 24.0f;


	float lost_damage = fmaxf(0.0f, v35 + thickness);

	if (lost_damage > data.current_damage)
		return false;

	if (lost_damage >= 0.0f)
		data.current_damage -= lost_damage;

	if (data.current_damage < 1.0f)
		return false;

	data.src = trace_exit.endpos;
	data.penetrate_count--;

	return true;
}


/*
*    CanHit() - example of how to use the code
*     @in  point: target hitbox vector
*     @out damage_given: amount of damage the shot would do
*/
bool CanHit(C_BaseEntity* entity,const Vector &point, float *damage_given)
{
	//Utils::ToLog("CANHIT");
	auto *local = g_EntityList->GetClientEntity(g_Engine->GetLocalPlayer());
	auto data = FireBulletData(local->GetOrigin() + local->GetViewOffset());
	data.filter = CTraceFilter();
	data.filter.pSkip = local;

	Vector angles;
//	CalcAngle(data.src, point, angles);
	VectorAngles(point - data.src, angles);
	AngleVectors(angles, &data.direction);
	VectorNormalize(data.direction);

	if (SimulateFireBullet(entity, local, reinterpret_cast<CBaseCombatWeapon*>(g_EntityList->GetClientEntityFromHandle(static_cast<HANDLE>(local->GetActiveWeaponHandle()))), data))
	{
		*damage_given = data.current_damage;
		//Utils::ToLog("CANHIT END");
		return true;
	}

	return false;
}